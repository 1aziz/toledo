---
version: 3

dotenv: [".env"]

tasks:
  default:
    desc: List all tasks
    cmds:
      - task -a

  bootstrap:
    desc: Bootstrap a kind cluster
    cmds:
      - task: create-kind-cluster
      - task: install:cilium
      - task: create-regcred
      - task: bootstrap-flux

  create-kind-cluster:
    desc: Create a Kind cluster
    cmds:
      - kind delete cluster --name toledo-local
      - kind create cluster --config kind-cluster-config.yaml --name toledo-local
      - kubectl cluster-info --context kind-toledo-local
    dir: ./infra/kind

  create-gke-cluster:
    desc: Create a GKE cluster (Autopilot)
    cmds:
      - gcloud components install gke-gcloud-auth-plugin
      - pulumi up -y
    dir: ./infra/gke

  bootstrap-flux:
    desc: Bootstrap Flux for GitHub
    deps: [install:flux]
    cmds:
      - |
        export GITHUB_TOKEN=$GH_TOKEN && \
        flux bootstrap --force github \
          --owner=$GH_USER \
          --repository=toledo \
          --branch=main \
          --path=./k8s/clusters/kind \
          --token=$GH_TOKEN \
          --personal

  install:cilium:
    desc: Install Cilium
    cmds:
      - helm repo add cilium https://helm.cilium.io/ --force-update
      - helm install cilium cilium/cilium --version 1.15.3 --namespace kube-system
    status:
      - printenv PLATFORM | grep -w KIND

  install:flux:
    desc: Install Flux
    cmds:
      - kubectl apply -f https://github.com/fluxcd/flux2/releases/latest/download/install.yaml

  create-regcred:
    desc: Create a regcred secret
    cmds:
      - kubectl create secret docker-registry regcred --docker-server=$GH_REPO --docker-username=$GH_USER --docker-password=$GH_TOKEN --docker-email=$GH_EMAIL
